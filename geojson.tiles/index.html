<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Leaflet.Select.GeoJSON.Tiles</title>

    <link rel="stylesheet" href="assets/bootstrap-3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/leaflet-0.7.5/leaflet.css">

    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 550px
        }		
    </style>

</head>

<body>
	<div class="container">	
		
        <div id="hr-divider">
            <hr>
        </div>

        <div id="map" class="centerish"></div>
        <form>
            <div class="form-group">
             <label style="font-size: 12px;">Selected features:</label>
             <label style="font-size: 12px;" id="selectedCount">0</label>
             <textarea class="form-control" value="" rows="2" id="selectedFeatures"></textarea>
         </div>
     </form>


     <div id="hr-divider">
        <hr>
    </div>	

</div>		

<script src="assets/jquery-1.11.3.min.js"></script>
<script src="assets/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="assets/leaflet-0.7.5/leaflet.js"></script>
<script src="assets/TileLayer.GeoJSON.js"></script>

<script>
	
	
        // add OpenStreetMap layer
        var layerOSM = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; Map Data <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

		// add MapBoxImagery layer
        var layerMapBoxImagery = new L.tileLayer('http://{s}.tiles.mapbox.com/v4/openstreetmap.map-inh7ifmo/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoib3BlbnN0cmVldG1hcCIsImEiOiJhNVlHd29ZIn0.ti6wATGDWOmCnCYen-Ip7Q', {
            maxZoom: 17,
            attribution: 'Data &copy; <a href="http://www.openstreetmap.org/copyright/en">OSM</a> contributors (ODbL), rendering ' +
            '<a href="http://giscience.uni-hd.de/" target="_blank">GIScience Research Group @ University of Heidelberg</a>'
        });		



        // initialize map
        var map = new L.Map('map', {
            minZoom: 1,
            maxZoom: 18,
            layers: [layerOSM]
        }).setView([51.083, 28.189], 10);

        var baseMaps = {
         "OpenStreetMap": layerOSM,
         "MapBox Imagery": layerMapBoxImagery
     };
     L.control.layers(baseMaps, null, {collapsed: false}).addTo(map);



//------------------------------------------------------------------------------------------------

var style = {
    color: "#C96A7B",
    fill: true,
    opacity: 1,
    fillOpacity: 0.001,
    weight: 3
};

var hoverStyle = {
    weight: 3,
    color: "#00FFFF",
    opacity: 1,
    fillOpacity: 0.1
};

//var geojsonURL = 'data/geojson.tiles.tilestache/{z}/{x}/{y}.json';
var geojsonURL = 'data/geojson.tiles.mmt/{z}/{x}/{y}.geojson';

var geojsonTileLayer = new L.TileLayer.GeoJSON(geojsonURL, {
    clipTiles: true,
    unique: function(feature) {
        return feature.properties.gid;
        //console.log(feature.properties.gid);
    }
}, {
    style: style,
    onEachFeature: function(feature, layer) {



            layer.on('click', function() {



// при выборе ячейки передается два объекта если ячейка на границе тайла
// передать выбранные ячейки в массив
// если для выбранного объекта уже существует идентичный объект в массиве - то удалять его из массива (и не добавлять новый объект)

// отрисовывать массив на карте
// выводить атрибыты всех объектов из массива



// проблемы Tilestache vt:
// есть линии разрезки тайлов

// проблемы mmt vt:
// mmt тайлы отображаются корректно (за счет опции перекрытия), но при выделении ячейки заметны границы перекрытия
// необходимо дополнительно изменить кодировку для тайлов

    
    var selectedTopo = null;
    selectedTopo = feature;


    drawLayer(selectedTopo);


                   //console.log(arrG.properties.gid);
                    



                   // L.geoJson(arrG).addTo(map);





            });





    }
});
map.addLayer(geojsonTileLayer);




// инициализируем новый слой, который будет отображаться на карте
var selectedFeatureLayer = L.geoJson(null, { 

});




// инициализируем функцию, которая будет передавать данные из выбранной ячейки в слой для отображения данных на карте
var drawLayer = function drawLayer(selectedTopo) {
    console.log(selectedTopo);

    selectedFeatureLayer.addData(selectedTopo);
    selectedFeatureLayer.addTo(map);
};


























/*
        if (feature.properties) {
            var popupString = '<div class="popup">';
            for (var k in feature.properties) {
                var v = feature.properties[k];
                popupString += k + ': ' + v + '<br />';
            }
            popupString += '</div>';
            layer.bindPopup(popupString);
            console.log(feature.properties);

        }
*/


/*
        if (!(layer instanceof L.Point)) {
            layer.on('mouseover', function() {
                layer.setStyle(hoverStyle);
            });
            layer.on('mouseout', function() {
                layer.setStyle(style);
            });
        }

*/







/*		
		select deselect tile
		
	        var style = {
            "clickable": true,
            "color": "#00D",
            "fillColor": "#00D",
            "weight": 1.0,
            "opacity": 0.3,
            "fillOpacity": 0.2
        };
        var hoverStyle = {
            "fillOpacity": 0.5
        };

        var geojsonURL = 'data/mmt.vector.tiles.kharkov.buildings/{z}/{x}/{y}.geojson';

        var geojsonTileLayer = new L.TileLayer.GeoJSON(geojsonURL, {
            clipTiles: true,
            unique: function(feature) {
                return feature.properties.gid;
                console.log(feature.properties.gid);
            }
        }, {
            style: style,
            onEachFeature: function(feature, layer) {
                */

			/*
			
                if (feature.properties) {
                    var popupString = '<div class="popup">';
                    for (var k in feature.properties) {
                        var v = feature.properties[k];
                        popupString += k + ': ' + v + '<br />';
                    }
                    popupString += '</div>';
                    layer.bindPopup(popupString);
                }
                if (!(layer instanceof L.Point)) {
                    layer.on('mouseover', function() {
                        layer.setStyle(hoverStyle);
                    });
                    layer.on('mouseout', function() {
                        layer.setStyle(style);
                    });
                };
                */

/*			
                layer.on({
                    click: function(e) {

                        var layer = e.target;
						

                        if (layer.feature.properties.selected == true) {
						
                            layer.setStyle({
								"clickable": true,
								"color": "#00D",
								"fillColor": "#00D",
								"weight": 1.0,
								"opacity": 0.3,
								"fillOpacity": 0.2
                            });						
						
							
							layer.feature.properties.selected = false;
							
							console.log("deselected " + feature.properties.gid);
							
                        } else {
						
                            layer.setStyle({
                                weight: 3,
                                color: "#00FFFF",
                                opacity: 1,
                                fillOpacity: 0.1
                            });

							console.log("selected " + feature.properties.gid);
							
							e.target.feature.properties.selected = true;

                        }

                    }
                });

				
            }
        });
        map.addLayer(geojsonTileLayer);	
		
		
        */		





/*
	
        // add topo250 layer		
        var topo250 = L.geoJson(null, {
            style: function(feature) {
                return {
                    color: "red",
                    fill: true,
                    opacity: 1,
                    fillOpacity: 0.001,
                    weight: 1
                }
            },
            onEachFeature: function(feature, layer_topo250) {

                layer_topo250.on({
                    click: function(e) {

                        var layer_topo250 = e.target;

                        if (layer_topo250.options.color == '#00FFFF') {
						
                            topo250.resetStyle(e.target);
							
							e.target.feature.properties.selected = false;
							
							//console.log("deselected " + feature.properties.name);
							
                        } else {
						
                            layer_topo250.setStyle({
                                weight: 3,
                                color: "#00FFFF",
                                opacity: 1,
                                fillOpacity: 0.1
                            });

							//console.log("selected " + feature.properties.name);
							
							e.target.feature.properties.selected = true;

							//$('#selectedFeatures').text( feature.properties.name );
							
							
                        }
					
											
						getAllElements();
					
                        if (!L.Browser.ie && !L.Browser.opera) {
                            layer_topo250.bringToFront();
                        }

                    }
                });
            }
        });

        $.getJSON("data/topo250m.geojson", function(data) {   // 34KB
            topo250.addData(data);
        });
        topo250.addTo(map);

		

		function getAllElements() {
			var selectedFeatureName = [];
            $.each(map._layers, function (ml) {
                if (map._layers[ml].feature && map._layers[ml].feature.properties.selected === true) {
					selectedFeatureName.push(map._layers[ml].feature.properties.name);
                }
            });
            //console.log(selectedFeatureName);
			$('#selectedFeatures').text( selectedFeatureName );
			$('#selectedCount').text( selectedFeatureName.length );
		};
		
        */		


    </script>

</body>

</html>